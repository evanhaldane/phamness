<!DOCTYPE html>
<style>
	.baseline {
		fill: none;
		stroke: red;
		stroke-linejoin: round;
		stroke-linecap: round;
		stroke-width: 3.5;
	}
	.similar {
		fill: none;
		stroke: #999999;
		stroke-linejoin: round;
		stroke-linecap: round;
		stroke-width: 1.5;
	}
</style>
<link rel="stylesheet" href="auto-complete.css">
<svg width="960" height="500">
</svg>
<head>
	<meta charset="utf-8"/>
	<title>phamNess</title>
	<script src="https://d3js.org/d3.v4.min.js"></script>
	<script src="auto-complete.min.js"></script>
	<script type="text/javascript">

		var svg = d3.select("svg"),
	    margin = {top: 20, right: 20, bottom: 30, left: 50},
	    width = +svg.attr("width") - margin.left - margin.right,
	    height = +svg.attr("height") - margin.top - margin.bottom,
	    g = svg.append("g").attr("transform", "translate(" + margin.left + "," + margin.top + ")"),
	    players;
		
		var x = d3.scaleLinear()
	    	.domain([28, 33])
	    	.rangeRound([0, width]);
	   	var y = d3.scaleLinear()
	    		.domain([-2, 10])
	    	    .rangeRound([height, 0]);

	    g.append("g")
			.attr("class", "xaxis")
			.attr("transform", "translate(0," + height + ")")
			.call(d3.axisBottom(x).ticks(5).tickFormat(d3.format(".0f")));
		
		g.append("g")
	        .call(d3.axisLeft(y))
	        .append("text")
	        .attr("fill", "#000")
	        .attr("transform", "rotate(-90)")
	        .attr("y", 6)
	        .attr("dy", "0.71em")
	        .attr("text-anchor", "end")
	        .text("WAR");


    	function compareTo(baseId){
			const comparisonYear = 2017;
			const yearsToConsider = 3;
			var baselinePlayer = players.find((d) => d.key == baseId);
			const minAge = (baselinePlayer.values[0].Age - baselinePlayer.values[0].Season +
							 comparisonYear - yearsToConsider + 1);
			const maxAge = minAge + 4;
			//baselinePlayer.values = baselinePlayer.values.filter((year) => year.Season >= comparisonYear - 2);
			//baselinePlayer.values = baselinePlayer.values.sort((year1, year2) => year1.Age - year2.Age);
			players = players.map(function(player){
				player.difference = difference(baselinePlayer, player, minAge, maxAge);
				return player});
			
			var similar = players.sort((player1,player2) => player1.difference-player2.difference).slice(0, 11);
			similar = similar.map((player) => {
				player.values = player.values.sort((year1, year2) => year1.Age - year2.Age);
				return player;
				});
			
		    var x = d3.scaleLinear()
	    		.domain([minAge, maxAge])
	    	    .rangeRound([0, width]);

	    	var line = d3.line()
	    	    .x((d) => x(d.Age))
	    	    .y((d) => y(d.WAR));

	    	g.select(".xaxis")
				.call(d3.axisBottom(x).ticks(5).tickFormat(d3.format(".0f")));


			var similarSelection = g.selectAll("path.similar")
				.data(similar.slice(1,11));

			var baselineSelection = g.selectAll("path.baseline")
				.data(similar.slice(0,1));

			similarSelection.exit().remove();
			baselineSelection.exit().remove();

			similarSelection
				.enter()
				.append("path")
				.attr("class", "similar")
				.merge(similarSelection)
				.attr("d", (d) => line(d.values.filter((d)=>d.Age >= minAge && d.Age <= maxAge)));

			baselineSelection
				.enter()
				.append("path")
				.attr("class", "baseline")
				.merge(baselineSelection)
				.attr("d", (d) => line(d.values.filter((d)=>d.Age >= minAge && d.Age <= maxAge)));
    	}
		

		function difference(baselinePlayer, comparisonPlayer, minAge, maxAge){
			totalDiff = baselinePlayer.values.reduce((runningTotal, currentObj) => {
				baselineAge = currentObj.Age;
				if (baselineAge >= minAge && baselineAge <= maxAge){
					correspondingPlayerYear = comparisonPlayer.values.find((d)=>d.Age == baselineAge);
					currentDiff = Math.abs(+currentObj.WAR - 
						(correspondingPlayerYear ? +correspondingPlayerYear.WAR : 0));
				} else {
					currentDiff = 0;
				}
				return runningTotal + currentDiff;
			}, 0);

			return totalDiff;
		}

		document.addEventListener("DOMContentLoaded", function(){
  			// Handler when the DOM is fully loaded

  			d3.csv("seasons.csv", function(data){
				players = d3.nest()
							.key((d)=>d.playerid)
							.entries(data);

				var recentPlayers = players.filter((player) => player.values.some((d)=>d.Season == "2017"));
				recentPlayers = recentPlayers.map((d) => ({id: d.key, Name: d.values[0].Name}));
				
				new autoComplete({
				    selector: '#inputPlayerName',
				    minChars: 2,
				    source: function(term, suggest){
				        term = term.toLowerCase();
				        var matches = [];
				        for (i=0; i<recentPlayers.length; i++) {
				            if (~recentPlayers[i].Name.toLowerCase().indexOf(term)) {
				            	matches.push(recentPlayers[i]);
				            }
				        }
				        suggest(matches);
			    	},
					renderItem: function (item, search){
					        search = search.replace(/[-\/\\^$*+?.()|[\]{}]/g, '\\$&');
					        var re = new RegExp("(" + search.split(' ').join('|') + ")", "gi");
					        return '<div class="autocomplete-suggestion" data-id="' +
					        		item.id + '" data-name="' + item.Name + '" data-val="' + 
					        		search + '">'+item.Name.replace(re, "<b>$1</b>")+'</div>';
					    },
					onSelect: function(e, term, item){
					    	playerid = +item.getAttribute('data-id');
					    	document.getElementById("inputPlayerName").value = item.textContent;
					    	compareTo(playerid);
					    }
	    		});
			});

		});

	</script>
</head>
<body>
	<form id="playerForm">
		<input type="text" id="inputPlayerName">
	</form>
</body>