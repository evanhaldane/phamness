<!DOCTYPE html>
<style>
	.baseline {
		fill: none;
		stroke: red;
		stroke-linejoin: round;
		stroke-linecap: round;
		stroke-width: 3.5;
	}
	.similar {
		fill: none;
		stroke: #999999;
		stroke-linejoin: round;
		stroke-linecap: round;
		stroke-width: 1.5;
	}
</style>
<link rel="stylesheet" href="auto-complete.css">
<svg width="960" height="500">
</svg>
<head>
	<meta charset="utf-8"/>
	<title>phamNess</title>
	<script src="https://d3js.org/d3.v4.min.js"></script>
	<script src="auto-complete.min.js"></script>
	<script type="text/javascript">

		var svg = d3.select("svg"),
	    margin = {top: 20, right: 20, bottom: 30, left: 50},
	    width = +svg.attr("width") - margin.left - margin.right,
	    height = +svg.attr("height") - margin.top - margin.bottom,
	    g = svg.append("g").attr("transform", "translate(" + margin.left + "," + margin.top + ")"),
	    players;

    	function compareTo(baseId){
			const comparisonYear = 2017;
			var baselinePlayer = players.find((d) => d.key == baseId);
			baselinePlayer.values = baselinePlayer.values.sort((year1, year2) => year1.Age - year2.Age);
			baselinePlayer.values = baselinePlayer.values.filter((year) => year.Season >= comparisonYear - 2);
			const ageInComparisonYear = baselinePlayer.values[0].Age - baselinePlayer.values[0].Season + comparisonYear;
			players = players.map(function(obj){
				obj.difference = difference(baselinePlayer.values, obj.values);
				return obj});
			players = players.map((player) => {
					player.values = player.values.filter((year) => 
						year.Age >= ageInComparisonYear - 2 && year.Age <= ageInComparisonYear + 2);
					return player;
				});
			var similar = players.sort((player1,player2) => player1.difference-player2.difference).slice(1, 11);
			similar = similar.map((player) => {
				player.values = player.values.sort((year1, year2) => year1.Age - year2.Age);
				return player;
				});
			
		    var x = d3.scaleLinear()
	    		.domain([ageInComparisonYear - 2, ageInComparisonYear + 2])
	    	    .rangeRound([0, width]);

	    	var y = d3.scaleLinear()
	    		.domain([-2, 10])
	    	    .rangeRound([height, 0]);

	    	var line = d3.line()
	    	    .x((d) => x(d.Age))
	    	    .y((d) => y(d.WAR));

			g.append("g")
				.attr("transform", "translate(0," + height + ")")
				.call(d3.axisBottom(x).ticks(5).tickFormat(d3.format(".0f")));

	        g.append("g")
	        	.call(d3.axisLeft(y))
	        	.append("text")
	        	.attr("fill", "#000")
	        	.attr("transform", "rotate(-90)")
	        	.attr("y", 6)
	        	.attr("dy", "0.71em")
	        	.attr("text-anchor", "end")
	        	.text("WAR");

			var similarSelection = g.selectAll("path.similar")
				.data(similar);

			var baselineSelection = g.selectAll("path.baseline")
				.data([baselinePlayer]);

			similarSelection.exit().remove();
			baselineSelection.exit().remove();

			similarSelection
				.enter()
				.append("path")
				.attr("class", "similar")
				.merge(similarSelection)
				.attr("d", (d) => line(d.values));

			baselineSelection
				.enter()
				.append("path")
				.attr("class", "baseline")
				.merge(baselineSelection)
				.attr("d", (d) => line(d.values));
    	}
		

		function difference(basePlayerSeasons, comparisonPlayerSeasons){
			var diff = 0;
			for (var i = 0; i < basePlayerSeasons.length; i++){
				var age = basePlayerSeasons[i].Age;
				var compare = comparisonPlayerSeasons.filter((year)=>year.Age == age);
				if (compare.length > 0){
					diff += Math.abs(basePlayerSeasons[i].WAR - compare[0].WAR);
				} else {
					diff += Math.abs(basePlayerSeasons[i].WAR);
				}
			}
			return diff;
		}

		document.addEventListener("DOMContentLoaded", function(){
  			// Handler when the DOM is fully loaded

  			d3.csv("seasons.csv", function(data){
				players = d3.nest()
							.key((d)=>d.playerid)
							.entries(data);

				var playerObjects = players.map((d) => ({id: d.key, Name: d.values[0].Name}));
				
				new autoComplete({
				    selector: '#inputPlayerName',
				    minChars: 2,
				    source: function(term, suggest){
				        term = term.toLowerCase();
				        var matches = [];
				        for (i=0; i<playerObjects.length; i++) {
				            if (~playerObjects[i].Name.toLowerCase().indexOf(term)) {
				            	matches.push(playerObjects[i]);
				            }
				        }
				        suggest(matches);
			    	},
					renderItem: function (item, search){
					        search = search.replace(/[-\/\\^$*+?.()|[\]{}]/g, '\\$&');
					        var re = new RegExp("(" + search.split(' ').join('|') + ")", "gi");
					        return '<div class="autocomplete-suggestion" data-id="' +
					        		item.id + '" data-name="' + item.Name + '" data-val="' + 
					        		search + '">'+item.Name.replace(re, "<b>$1</b>")+'</div>';
					    },
					onSelect: function(e, term, item){
					    	playerid = +item.getAttribute('data-id');
					    	document.getElementById("inputPlayerName").value = item.textContent;
					    	compareTo(playerid);
					    }
	    		});
			});

		});

	</script>
</head>
<body>
	<form id="playerForm">
		<input type="text" id="inputPlayerName">
	</form>
</body>